# В данном репозитории содержится информация о процессе портирования godot4 на ОС Аврора

### Создание проекта в godot
В самом игровом движке необходимо будет создать проект, который необходимо будет запустить на самом устройстве с ОС Аврора.  Перевести его в режим "Совместимость".

Далее проект необходимо будет экспортировать "Project->Export..."
![[Pasted image 20250919135350.png]]
После чего необходимо добавить пресет для экспорта под Linux. 
![[Pasted image 20250919135551.png]]
Далее в настройках шаблона для экспорта ставим галочку в пункет "ETC2 ASTC" и переходим в раздел "Export PCK/ZIP..."
![[Pasted image 20250919135946.png]]
Важно, что экспортировать необходимо в формате ".pck".
После этого можно перейти к этапу работы с Build Engine. 

### Работа в среде для сборки Build Engine.
Для получения доступа к Build Engine необходимо установить AuroraSDK, в качестве технологии виртуализации выбрать VirtualBox или же Docker. Выбор Docker в данном случае предпочтительнее, так как он гораздо эффективнее использует ресурсы системы, из-за чего процесс сборки будет проходить быстрее. 

Для обеспечения более стабильного и унифицированного процесса сборки, рекомендуется использовать утилиту - "sfdk", которая поставляется вместе с AuroraSDK.

Для этого необходимо задать ей `alias`:
```bash
alias sfdk=~/AuroraOS/bin/sfdk
```
В моем же случае, я напрямую работал в Docker-контейнере. 
Для начала, необходимо поставить необходимые для работы godot зависимости на таргеты, представленные в BuildEngine. Таргеты - это по набор компиляторов, библиотек, позволяющих производить сборку под различные архитектуры и версии ОС Аврора. 
#### Запуск docker контейнера и настройка таргетов
Для работы с BuildEngine напрямую в docker необходимо:
Поднять контейнер:
```bash
docker run --network host -it -v /home/yareg/Documents/docker:/home/mersdk/docker aurora-os-build-engine-5.1.3.85-mb2:yareg /bin/bash
```
 - `/home/yareg/Documents/docker:/home/mersdk/docker` - я монтирую свою директорию с исходниками godot к контейнеру. Здесь важно упомянуть, что в моем случае `/home/yareg/Documents/docker` содержит исходники самого godot с которым я буду работать. Если же исходников нет, то можно клонировать официальный репозиторий godot. 
 - aurora-os-build-engine-5.1.3.85-mb2:yareg - имя образа, из которого будет создаваться контейнер
После захода на контейнер необходимо убедиться, что пользователем, под которым был выполнен вход является `mersdk`, если же нет, то перейти на него.
Заходим на необходимый таргет:
```bash
sb2 -t AuroraOS-5.1.3.85-MB2-armv7hl -m sdk-install -R
```
Установка зависимостей для godot:
```bash
zypper install git autoconf automake autopoint make libtool pkgconfig gcc ncurses m4 gperf gettext byacc flex perl intltool libpng llvm zlib libgdm libudev libgcrypt fontconfig freetype doxygen pixman mesa-llvmpipe meson scons clang wayland-utils
```
#### Сборка шаблона для экспорта из исходников игрового движка
После того, как зависимости были поставлены, необходимо перейти к сборке шаблона для экспорта из исходников godot. Переходим в директорию игрового движка и выполняем команду:
```bash
scons platform=linuxbsd wayland=yes x11=no target=template_debug debug_symbols=yes use_llvm=no gcc=yes arch=arm32 CCFLAGS="-g -O0" CXXFLAGS="-g -O0" LINKFLAGS="-g" use_sowrap=no -j8 
```
Здесь важно отметить, что полученный шаблон для экспорта использовался для отладки приложения, поэтому он содержит множество флагов для предоставления максимальной информации при процессе отладки: `target=template_debug debug_symbols=yes CCFLAGS="-g -O0" CXXFLAGS="-g -O0" LINKFLAGS="-g"`
Также важным моментом является отключение динамической линковки библиотек, потому что для своей работы godot требует библиотеки, которых нет в ОС Аврора, но которые также нельзя на нее установить. В данном случае, все необходимые библиотеки будут подтягиваться из устройства, а проблемные библиотеки будут предоставляться вместе с приложением и при установке .rpm-пакета на устройство, храниться в директории самого приложения.

#### Сборка .rpm-пакета
После того, как сборка шаблона для экспорта из исходников godot'а прошла успешно, переходим к сборке .rpm-пакета в который будет происходить упаковка проекта и шаблона для экспорта.

Для сборки .rpm-пакета кроме .pck-файла с проектом, полученного при экспорте из godot'a и шаблона для экспорта полученного при сборке из исходников godot'a. Также понадобятся:
- Ключ и сертификат, для подписи .rpm-пакета, так как каждый пакет, который устанавливается на устройство должен быть подписан.
- Конфигурационные файлы
- Скрипт, автоматизирующий процесс сборки
Конфигурационные файлы, а также файлы со скриптами представлены в репозитории.
Исходня из указанных в файле generate.sh полей, будет производиться генерация конфигурационных файлов, с указанными параметрами. 

После запуска файла - build_rpm.sh  будет собран, подписан и провалидирован .rpm-пакет с проектом, который можно устанавливать на устройство. 

### Установка .rpm-пакета на устройство
Для установки .rpm-пакета необходимо будет воспользоваться утилитой gdbus:
```bash
gdbus call --system --dest ru.omp.APM --object-path /ru/omp/APM --method ru.omp.APM.Install <путь_до_пакета> {}
```
При запуске .rpm-пакета необходимо будет подтянуть .pck-файл, который также был установлен в директорию с приложением.
Если производить запуск из директории с самим бинарником, то эта процедура достигается командой:
```bash
./ru.yareg.game --main-pack ../data/empty.pck
```
Название бинарника и .pck-файла наверняка будут отличаться.

### Отладка проекта
В процессе портирования необходимо было вносить изменения в исходники игрового движка, поэтому для обнаружения проблемных мест использовалась его отладка. 
Для отладки использовалась утилита gdb. 
На самом устройстве запускается gdbserver:
```bash
gdbserver --multi :2345 /opt/app/ru.yareg.game/current/bin/ru.yareg.game --main-pack /opt/app/ru.yareg.game/current/data/emptyDebug.pck
```
К которому или же по wi-fi или же по usb-проводу производилось подключение с моей linux машины. Для удобства использовался редактор `vs code`. 
В нем, после установки плагинов для работы GNU Debugger и возможности дебажить код написанный на C++. Я создал launch.json файл:
```json
{
	"version": "0.2.0",
	"configurations": [
		{
			"name": "Debug on Device",
			"type": "cppdbg",
			"request": "launch",
			"program": "${workspaceFolder}/new/usr/bin/ru.yareg.game",
			"sourceFileMap": {
			"/home/mersdk/docker/godot": "/home/yareg/Documents/docker/godot"
			},
			"stopAtEntry": false,
			"cwd": "${workspaceFolder}",
			"MIMode": "gdb",
			"miDebuggerPath": "/home/yareg/Programs/bin/gdb-armv7hl-meego-linux-gnueabi",
			"miDebuggerServerAddress": "192.168.78.248:2345",
		}
	]
}
```
Здесь:
- sourceFileMap - путь до исходников godot, которые будут изменяться
- program - путь до копии бинарника, который имеется на устройстве
- miDebuggerPath - путь до отладчика поставляемого вместе с AuroraSDK
- miDebuggerServerAddress - адрес сервера, по которому будет производиться подключение

